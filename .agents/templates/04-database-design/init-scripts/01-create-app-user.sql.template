-- =====================================================
-- Init Script: 01-create-app-user.sql
-- Description: Cria usuários dedicados para a aplicação
-- Security: Princípio do Menor Privilégio (Least Privilege)
-- Project: {PROJECT_NAME}
-- Author: DBA Agent
-- Date: Generated from template
-- =====================================================
--
-- Este script é executado automaticamente pelo PostgreSQL
-- na inicialização do container (via /docker-entrypoint-initdb.d/)
--
-- IMPORTANTE: Apenas executado na PRIMEIRA inicialização
-- (quando o volume do PostgreSQL está vazio)
--
-- SECURITY NOTE:
-- - NUNCA usar o usuário 'postgres' (superuser) na aplicação
-- - Usar '{PROJECT}_app' para a aplicação
-- - Usar '{PROJECT}_readonly' para analytics/backups
-- =====================================================

-- Conectar ao database da aplicação
\c {PROJECT}_dev;

\echo '================================================='
\echo 'Creating application users for {PROJECT_NAME}'
\echo '================================================='

-- =====================================================
-- USER 1: {PROJECT}_app (Application User)
-- Purpose: Main application database user
-- Permissions: CRUD + CREATE TABLE (for migrations)
-- =====================================================

DO
$$
BEGIN
    -- Criar usuário para aplicação (development)
    IF NOT EXISTS (SELECT FROM pg_catalog.pg_user WHERE usename = '{PROJECT}_app') THEN
        CREATE USER {PROJECT}_app WITH
            PASSWORD 'app_dev_password_123'
            NOCREATEDB
            NOCREATEROLE
            NOSUPERUSER;
        RAISE NOTICE '✓ User {PROJECT}_app created successfully';
    ELSE
        RAISE NOTICE '! User {PROJECT}_app already exists';
    END IF;
END
$$;

-- =====================================================
-- SECURITY: Revogar acesso a databases do sistema
-- =====================================================
-- Por padrão, PostgreSQL permite conexão a qualquer database.
-- Devemos revogar explicitamente para aplicar Least Privilege.

REVOKE CONNECT ON DATABASE template0 FROM {PROJECT}_app;
REVOKE CONNECT ON DATABASE template1 FROM {PROJECT}_app;
REVOKE CONNECT ON DATABASE postgres FROM {PROJECT}_app;

\echo '✓ Revoked access to system databases (template0, template1, postgres)'

-- Grant permissões APENAS no database da aplicação
GRANT CONNECT ON DATABASE {PROJECT}_dev TO {PROJECT}_app;
GRANT USAGE ON SCHEMA public TO {PROJECT}_app;

-- Permissões em tabelas existentes (CRUD)
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO {PROJECT}_app;

-- Permissões em sequências (para SERIAL/IDENTITY/auto-increment)
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO {PROJECT}_app;

-- Permissões futuras (para tabelas criadas depois - importante para migrations)
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO {PROJECT}_app;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT USAGE, SELECT ON SEQUENCES TO {PROJECT}_app;

-- Permitir criação de tabelas (necessário para migrations)
GRANT CREATE ON SCHEMA public TO {PROJECT}_app;

\echo '✓ Permissions granted to {PROJECT}_app:'
\echo '  - CONNECT on database'
\echo '  - SELECT, INSERT, UPDATE, DELETE on tables'
\echo '  - USAGE, SELECT on sequences'
\echo '  - CREATE TABLE (for migrations)'

-- =====================================================
-- USER 2: {PROJECT}_readonly (Read-Only User)
-- Purpose: Analytics, Reports, Backups
-- Permissions: SELECT only
-- =====================================================

DO
$$
BEGIN
    -- Criar usuário read-only
    IF NOT EXISTS (SELECT FROM pg_catalog.pg_user WHERE usename = '{PROJECT}_readonly') THEN
        CREATE USER {PROJECT}_readonly WITH
            PASSWORD 'readonly_dev_password_123'
            NOCREATEDB
            NOCREATEROLE
            NOSUPERUSER;
        RAISE NOTICE '✓ User {PROJECT}_readonly created successfully';
    ELSE
        RAISE NOTICE '! User {PROJECT}_readonly already exists';
    END IF;
END
$$;

-- Revogar acesso a databases do sistema (same as {PROJECT}_app)
REVOKE CONNECT ON DATABASE template0 FROM {PROJECT}_readonly;
REVOKE CONNECT ON DATABASE template1 FROM {PROJECT}_readonly;
REVOKE CONNECT ON DATABASE postgres FROM {PROJECT}_readonly;

-- Grant permissões apenas de leitura APENAS no database da aplicação
GRANT CONNECT ON DATABASE {PROJECT}_dev TO {PROJECT}_readonly;
GRANT USAGE ON SCHEMA public TO {PROJECT}_readonly;

-- Apenas SELECT em todas as tabelas
GRANT SELECT ON ALL TABLES IN SCHEMA public TO {PROJECT}_readonly;

-- Permissões futuras
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT ON TABLES TO {PROJECT}_readonly;

\echo '✓ Read-only permissions granted to {PROJECT}_readonly:'
\echo '  - CONNECT on database'
\echo '  - SELECT on tables (read-only)'

-- =====================================================
-- SECURITY SUMMARY
-- =====================================================

\echo ''
\echo '================================================='
\echo 'SECURITY SUMMARY - PostgreSQL Users'
\echo '================================================='
\echo ''
\echo 'USER: postgres (SUPERUSER)'
\echo '  Purpose: Database administration ONLY'
\echo '  Usage: Manual DBA tasks, troubleshooting'
\echo '  ⚠️  NEVER use in application connection string'
\echo ''
\echo 'USER: {PROJECT}_app (APPLICATION)'
\echo '  Purpose: Main application'
\echo '  Permissions: CRUD + CREATE TABLE'
\echo '  ✓ Can: SELECT, INSERT, UPDATE, DELETE, CREATE TABLE'
\echo '  ✗ Cannot: DROP DATABASE, CREATE ROLE, ALTER SYSTEM'
\echo '  ✗ Cannot: Connect to template0, template1, postgres'
\echo ''
\echo 'USER: {PROJECT}_readonly (READ-ONLY)'
\echo '  Purpose: Analytics, Reports, Backups'
\echo '  Permissions: SELECT only'
\echo '  ✓ Can: SELECT'
\echo '  ✗ Cannot: INSERT, UPDATE, DELETE, CREATE'
\echo '  ✗ Cannot: Connect to template0, template1, postgres'
\echo ''
\echo '================================================='
\echo 'Setup completed successfully!'
\echo '================================================='
\echo ''

-- Listar usuários criados (para verificação)
\du
