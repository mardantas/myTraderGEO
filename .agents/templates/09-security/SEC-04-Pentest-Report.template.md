<!--
MARKDOWN FORMATTING:
- Use 2 spaces at end of line for compact line breaks (metadata)
- Use blank lines between sections for readability (content)
- Validate in Markdown preview before committing
-->

# SEC-04: Penetration Test Report

**Projeto:** [NOME-DO-PROJETO]
**Data:** [DATA]
**Security Specialist:** [NOME]
**Versão:** 1.0

---

## 🎯 Objetivo

Executar **penetration testing** para identificar vulnerabilidades em produção antes de atacantes reais.

---

## 📋 Test Scope

### In-Scope

- [ ] **Web Application:** Frontend (React SPA) + Backend APIs
- [ ] **API Endpoints:** RESTful APIs (autenticados e públicos)
- [ ] **Authentication:** Login, JWT tokens, session management
- [ ] **Authorization:** RBAC, role escalation attempts
- [ ] **Database:** SQL injection, NoSQL injection
- [ ] **Infrastructure:** Exposed services, misconfigurations

### Out-of-Scope

- [ ] **Physical security** (data center)
- [ ] **Social engineering** (phishing tests)
- [ ] **DoS/DDoS attacks** (production uptime must be maintained)
- [ ] **Third-party services** (Stripe, AWS, etc.)

### Test Environment

| Environment | URL | Status |
|-------------|-----|--------|
| **Staging** | https://staging.app.[DOMAIN] | ✅ Primary test target |
| **Production** | https://app.[DOMAIN] | ⚠️ Read-only tests only |

**Rules of Engagement:**
- No destructive tests in production
- Tests run during off-peak hours (2-6 AM UTC)
- Notify DevOps team before starting

---

## 🛠️ Testing Methodology

### OWASP Top 10 (2021)

| # | Vulnerability | Test Approach | Status |
|---|---------------|---------------|--------|
| **A01** | Broken Access Control | Role escalation, IDOR | ✅ Tested |
| **A02** | Cryptographic Failures | TLS config, password storage | ✅ Tested |
| **A03** | Injection | SQL injection, XSS, LDAP | ✅ Tested |
| **A04** | Insecure Design | Business logic flaws | ✅ Tested |
| **A05** | Security Misconfiguration | Default credentials, debug mode | ✅ Tested |
| **A06** | Vulnerable Components | Outdated dependencies | ✅ Tested |
| **A07** | Identification & Auth | Brute force, weak passwords | ✅ Tested |
| **A08** | Software & Data Integrity | Unsigned packages, deserialization | ✅ Tested |
| **A09** | Security Logging Failures | Missing audit logs | ✅ Tested |
| **A10** | Server-Side Request Forgery | SSRF attacks | ✅ Tested |

### Testing Tools

```bash
# Automated scanners
- OWASP ZAP (web vulnerability scanner)
- Burp Suite Professional (proxy + scanner)
- Nuclei (template-based scanner)
- SQLMap (SQL injection)
- Nikto (web server scanner)

# Manual testing
- Postman (API testing)
- Browser DevTools (client-side testing)
- JWT.io (token inspection)
```

---

## 🚨 Findings (Vulnerabilities)

### Severity Classification

| Severity | CVSS Score | Impact | Response Time |
|----------|------------|--------|---------------|
| **Critical** | 9.0 - 10.0 | System compromise | Fix immediately (24h) |
| **High** | 7.0 - 8.9 | Data breach risk | Fix within 7 days |
| **Medium** | 4.0 - 6.9 | Limited impact | Fix within 30 days |
| **Low** | 0.1 - 3.9 | Minimal impact | Fix when convenient |

---

### CRITICAL Findings

#### CRIT-001: SQL Injection in Search Endpoint

**Severity:** Critical (CVSS 9.8)
**CWE:** CWE-89 (Improper Neutralization of SQL Commands)
**Affected Component:** `GET /api/v1/orders?search={query}`

**Description:**

The `search` parameter is directly concatenated into SQL query without sanitization.

**Proof of Concept:**

```bash
# Request
GET /api/v1/orders?search=test' OR '1'='1

# Response
200 OK
[
  { "id": 1, "userId": 123, "amount": 100 },  # Should not be visible!
  { "id": 2, "userId": 456, "amount": 200 },
  ...
]

# Attacker can extract entire database:
GET /api/v1/orders?search=test' UNION SELECT username,password,email FROM users--
```

**Vulnerable Code:**

```csharp
// ❌ VULNERABLE
public async Task<List<Order>> SearchOrders(string search)
{
    var sql = $"SELECT * FROM Orders WHERE Description LIKE '%{search}%'";
    return await _db.QueryAsync<Order>(sql);
}
```

**Remediation:**

```csharp
// ✅ FIXED - Use parameterized query
public async Task<List<Order>> SearchOrders(string search)
{
    return await _db.Orders
        .Where(o => EF.Functions.Like(o.Description, $"%{search}%"))
        .ToListAsync();
}
```

**Status:** 🔴 OPEN (discovered 2025-10-05)
**Assignee:** [DEVELOPER-NAME]
**Deadline:** 2025-10-06 (24 hours)

---

### HIGH Findings

#### HIGH-001: Insecure Direct Object Reference (IDOR)

**Severity:** High (CVSS 7.5)
**CWE:** CWE-639 (Authorization Bypass Through User-Controlled Key)
**Affected Component:** `GET /api/v1/orders/{orderId}`

**Description:**

Any authenticated user can access any order by guessing `orderId`, bypassing authorization.

**Proof of Concept:**

```bash
# User A (userId=123) can access User B's order (orderId=456)
GET /api/v1/orders/456
Authorization: Bearer [USER-A-TOKEN]

# Response
200 OK
{
  "id": 456,
  "userId": 789,  # Different user!
  "amount": 1000,
  "items": [...]
}
```

**Vulnerable Code:**

```csharp
// ❌ VULNERABLE - No authorization check
[HttpGet("{orderId}")]
public async Task<IActionResult> GetOrder(Guid orderId)
{
    var order = await _repository.GetByIdAsync(orderId);
    return Ok(order);
}
```

**Remediation:**

```csharp
// ✅ FIXED - Check authorization
[HttpGet("{orderId}")]
public async Task<IActionResult> GetOrder(Guid orderId)
{
    var order = await _repository.GetByIdAsync(orderId);
    var requestingUserId = User.FindFirst("sub")?.Value;

    if (order.UserId != requestingUserId && !User.IsInRole("Admin"))
    {
        return Forbid(); // 403 Forbidden
    }

    return Ok(order);
}
```

**Status:** 🔴 OPEN (discovered 2025-10-05)
**Assignee:** [DEVELOPER-NAME]
**Deadline:** 2025-10-12 (7 days)

---

#### HIGH-002: Weak Password Policy

**Severity:** High (CVSS 7.0)
**CWE:** CWE-521 (Weak Password Requirements)
**Affected Component:** User registration

**Description:**

Password policy allows weak passwords like "123456", "password".

**Proof of Concept:**

```bash
# User can register with weak password
POST /api/v1/auth/register
{
  "email": "test@example.com",
  "password": "123456"  # Accepted!
}
```

**Remediation:**

```csharp
// ✅ FIXED - Enforce strong password policy
builder.Services.Configure<IdentityOptions>(options =>
{
    options.Password.RequireDigit = true;
    options.Password.RequireLowercase = true;
    options.Password.RequireUppercase = true;
    options.Password.RequireNonAlphanumeric = true;
    options.Password.RequiredLength = 12; // Minimum 12 characters
    options.Password.RequiredUniqueChars = 4;
});

// Additionally: check against common password list (Have I Been Pwned API)
```

**Status:** 🔴 OPEN
**Assignee:** [DEVELOPER-NAME]
**Deadline:** 2025-10-12

---

### MEDIUM Findings

#### MED-001: Missing Security Headers

**Severity:** Medium (CVSS 5.3)
**CWE:** CWE-693 (Protection Mechanism Failure)
**Affected Component:** HTTPS responses

**Description:**

Missing security headers: `Content-Security-Policy`, `X-Frame-Options`, `X-Content-Type-Options`.

**Proof of Concept:**

```bash
curl -I https://app.[DOMAIN]

HTTP/2 200
content-type: text/html
# Missing headers:
# Content-Security-Policy
# X-Frame-Options
# X-Content-Type-Options
# Strict-Transport-Security
```

**Remediation:**

```csharp
// Program.cs
app.Use(async (context, next) =>
{
    context.Response.Headers.Add("Content-Security-Policy",
        "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';");
    context.Response.Headers.Add("X-Frame-Options", "DENY");
    context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
    context.Response.Headers.Add("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
    context.Response.Headers.Add("Referrer-Policy", "strict-origin-when-cross-origin");
    await next();
});
```

**Status:** 🔴 OPEN
**Deadline:** 2025-10-30

---

#### MED-002: JWT Token Expiry Too Long

**Severity:** Medium (CVSS 4.8)
**CWE:** CWE-613 (Insufficient Session Expiration)
**Affected Component:** JWT authentication

**Description:**

Access tokens valid for 24 hours (too long). Recommended: 15 minutes.

**Current Config:**

```csharp
// ❌ BAD
var token = new JwtSecurityToken(
    expires: DateTime.UtcNow.AddHours(24) // 24 hours!
);
```

**Remediation:**

```csharp
// ✅ GOOD
var accessToken = new JwtSecurityToken(
    expires: DateTime.UtcNow.AddMinutes(15) // 15 minutes
);

var refreshToken = new JwtSecurityToken(
    expires: DateTime.UtcNow.AddDays(7) // 7 days
);
```

**Status:** 🔴 OPEN
**Deadline:** 2025-10-30

---

### LOW Findings

#### LOW-001: Verbose Error Messages

**Severity:** Low (CVSS 3.1)
**CWE:** CWE-209 (Information Exposure Through Error Message)

**Description:**

Stack traces exposed in error responses (information leakage).

**Proof of Concept:**

```bash
GET /api/v1/orders/invalid-guid

# Response
500 Internal Server Error
{
  "error": "System.FormatException: Guid should contain 32 digits...",
  "stackTrace": "at System.Guid.Parse(String input)\n  at OrdersController.GetOrder(String orderId) in /app/Controllers/OrdersController.cs:line 42"
}
```

**Remediation:**

```csharp
// Program.cs
if (app.Environment.IsProduction())
{
    app.UseExceptionHandler("/error");
    // Never expose stack traces in production
}
```

**Status:** 🟡 OPEN
**Priority:** Low

---

## 📊 Summary

### Vulnerability Breakdown

```
Total Vulnerabilities: 7

Critical: 1  (14%)  🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴 (10/10 risk)
High:     2  (29%)  🟠🟠🟠🟠🟠🟠🟠 (7/10 risk)
Medium:   2  (29%)  🟡🟡🟡🟡🟡 (5/10 risk)
Low:      2  (29%)  🟢🟢🟢 (3/10 risk)
```

### OWASP Top 10 Coverage

```
A01: Broken Access Control       ✅ 2 findings (HIGH-001, MED-002)
A02: Cryptographic Failures       ✅ 1 finding (HIGH-002)
A03: Injection                    ✅ 1 finding (CRIT-001)
A04: Insecure Design              ✅ No findings
A05: Security Misconfiguration    ✅ 1 finding (MED-001)
A06: Vulnerable Components        ✅ No findings
A07: Identification & Auth        ✅ 1 finding (HIGH-002)
A08: Software & Data Integrity    ✅ No findings
A09: Security Logging Failures    ✅ 1 finding (LOW-001)
A10: SSRF                         ✅ No findings
```

---

## ✅ Remediation Plan

| Finding | Priority | Assignee | Deadline | Status |
|---------|----------|----------|----------|--------|
| CRIT-001: SQL Injection | 🔴 Critical | [DEV-1] | 2025-10-06 | 🔴 OPEN |
| HIGH-001: IDOR | 🟠 High | [DEV-2] | 2025-10-12 | 🔴 OPEN |
| HIGH-002: Weak Password | 🟠 High | [DEV-3] | 2025-10-12 | 🔴 OPEN |
| MED-001: Security Headers | 🟡 Medium | [DEV-4] | 2025-10-30 | 🔴 OPEN |
| MED-002: JWT Expiry | 🟡 Medium | [DEV-5] | 2025-10-30 | 🔴 OPEN |
| LOW-001: Error Messages | 🟢 Low | [DEV-6] | 2025-11-15 | 🔴 OPEN |
| LOW-002: [EXEMPLO] | 🟢 Low | [DEV-7] | 2025-11-15 | 🔴 OPEN |

---

## 🔄 Retest

**Retest Date:** [DATA] (após todas as correções)

**Retest Scope:**
- [ ] Verify CRIT-001 fixed (SQL injection)
- [ ] Verify HIGH-001 fixed (IDOR)
- [ ] Verify HIGH-002 fixed (password policy)
- [ ] Run full OWASP ZAP scan (regression test)

**Expected Outcome:** 0 Critical/High vulnerabilities

---

## ✅ Definition of Done

- [ ] Penetration test executado (OWASP Top 10)
- [ ] Vulnerabilidades documentadas (severity, POC, remediation)
- [ ] Remediation plan criado (prioridades, deadlines)
- [ ] Critical/High vulnerabilities corrigidas
- [ ] Retest executado (validar correções)
- [ ] SEC-04 entregue para stakeholders
- [ ] SEC-checklist.yml completo

---

**Próximos Passos:**
1. Corrigir vulnerabilidades CRITICAL/HIGH (deadline: 7 dias)
2. Executar retest após correções
3. SEC-05: Incident Response Plan (preparação para incidentes)

